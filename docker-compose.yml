services:
  api-gateway:
    container_name: api-gateway
    hostname: api-gateway
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    ports:
      - "${API_GATEWAY_PORT}:8080"
    volumes:
      - ./certs:/certs:ro
    user: "${UID}:${GID}"
    environment:
      PORT: ${API_GATEWAY_PORT}
      USER_SERVICE_GRPC_URL: ${USER_SERVICE_GRPC_URL}
      PRODUCT_SERVICE_GRPC_URL: ${PRODUCT_SERVICE_GRPC_URL}
      CART_SERVICE_GRPC_URL: ${CART_SERVICE_GRPC_URL}
      ORDER_SERVICE_GRPC_URL: ${ORDER_SERVICE_GRPC_URL}
      LOG_LEVEL: ${LOG_LEVEL}
      JWT_PRIVATE_KEY_PATH: /certs/private.pem
      JWT_PUBLIC_KEY_PATH: /certs/public.pem
      JWT_ISSUER: ${JWT_ISSUER}
      JWT_AUDIENCE: ${JWT_AUDIENCE}
      JWT_TTL_MINUTES: ${JWT_TTL_MINUTES}
      RATE_LIMITER_ENABLED: ${RATE_LIMITER_ENABLED}
      RATE_LIMITER_UNKNOWN_RPS: ${RATE_LIMITER_UNKNOWN_RPS}
      RATE_LIMITER_UNKNOWN_BURST: ${RATE_LIMITER_UNKNOWN_BURST}
      RATE_LIMITER_AUTH_RPS: ${RATE_LIMITER_AUTH_RPS}
      RATE_LIMITER_AUTH_BURST: ${RATE_LIMITER_AUTH_BURST}
      REDIS_URL: ${REDIS_URL}:${REDIS_PORT}
    depends_on:
      user-service:
        condition: service_healthy
      product-service:
        condition: service_healthy
      cart-service:
        condition: service_healthy
      order-service:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    networks:
      - services-network
      - redis-network

  user-service:
    container_name: user-service
    hostname: user-service
    build:
      context: .
      dockerfile: user-service/Dockerfile
    expose:
      - "${USER_SERVICE_GRPC_PORT}"
    environment:
      USER_SERVICE_GRPC_PORT: ${USER_SERVICE_GRPC_PORT}
      DATABASE_URL: postgres://${USER_POSTGRES_USER}:${USER_POSTGRES_PASSWORD}@user-db:5432/${USER_POSTGRES_DB}?sslmode=disable
      REDIS_URL: ${REDIS_URL}:${REDIS_PORT}
      MIGRATIONS_DIR: /migrations
      LOG_LEVEL: ${LOG_LEVEL}
    depends_on:
      user-db:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/grpc_health_probe", "-addr=:${USER_SERVICE_GRPC_PORT}", "-service=user-service"]
      interval: 10s
      timeout: 3s
      start_period: 10s
      retries: 3
    networks:
      - services-network
      - user-db-network
      - redis-network

  product-service:
    container_name: product-service
    hostname: product-service
    build:
      context: .
      dockerfile: product-service/Dockerfile
    expose:
      - "${PRODUCT_SERVICE_GRPC_PORT}"
    environment:
      PRODUCT_SERVICE_GRPC_PORT: ${PRODUCT_SERVICE_GRPC_PORT}
      DATABASE_URL: postgres://${PRODUCT_POSTGRES_USER}:${PRODUCT_POSTGRES_PASSWORD}@product-db:5432/${PRODUCT_POSTGRES_DB}?sslmode=disable
      REDIS_URL: ${REDIS_URL}:${REDIS_PORT}
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      MIGRATIONS_DIR: /migrations
      LOG_LEVEL: ${LOG_LEVEL}
    depends_on:
      product-db:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/grpc_health_probe", "-addr=:${PRODUCT_SERVICE_GRPC_PORT}", "-service=product-service"]
      interval: 10s
      timeout: 3s
      start_period: 10s
      retries: 3
    networks:
      - services-network
      - product-db-network
      - redis-network
      - rabbitmq-network

  cart-service:
    container_name: cart-service
    hostname: cart-service
    build:
      context: .
      dockerfile: cart-service/Dockerfile
    expose:
      - "${CART_SERVICE_GRPC_PORT}"
    environment:
      CART_SERVICE_GRPC_PORT: ${CART_SERVICE_GRPC_PORT}
      DATABASE_URL: postgres://${CART_POSTGRES_USER}:${CART_POSTGRES_PASSWORD}@cart-db:5432/${CART_POSTGRES_DB}?sslmode=disable
      REDIS_URL: ${REDIS_URL}:${REDIS_PORT}
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      MIGRATIONS_DIR: /migrations
      PRODUCT_SERVICE_GRPC_URL: ${PRODUCT_SERVICE_GRPC_URL}
      LOG_LEVEL: ${LOG_LEVEL}
      CART_TTL_HOURS: ${CART_TTL_HOURS}
    depends_on:
      cart-db:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
      product-service:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/grpc_health_probe", "-addr=:${CART_SERVICE_GRPC_PORT}", "-service=cart-service"]
      interval: 10s
      timeout: 3s
      start_period: 10s
      retries: 3
    networks:
      - services-network
      - cart-db-network
      - redis-network
      - rabbitmq-network

  order-service:
    container_name: order-service
    hostname: order-service
    build:
      context: .
      dockerfile: order-service/Dockerfile
    expose:
      - "${ORDER_SERVICE_GRPC_PORT}"
    environment:
      ORDER_SERVICE_GRPC_PORT: ${ORDER_SERVICE_GRPC_PORT}
      DATABASE_URL: postgres://${ORDER_POSTGRES_USER}:${ORDER_POSTGRES_PASSWORD}@order-db:5432/${ORDER_POSTGRES_DB}?sslmode=disable
      MIGRATIONS_DIR: /migrations
      LOG_LEVEL: ${LOG_LEVEL}
      CART_SERVICE_GRPC_URL: ${CART_SERVICE_GRPC_URL}
      USER_SERVICE_GRPC_URL: ${USER_SERVICE_GRPC_URL}
      PAYMENT_SERVICE_GRPC_URL: ${PAYMENT_SERVICE_GRPC_URL}
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
    depends_on:
      order-db:
        condition: service_healthy
      cart-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
      payment-service:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/grpc_health_probe", "-addr=:${ORDER_SERVICE_GRPC_PORT}", "-service=order-service"]
      interval: 10s
      timeout: 3s
      start_period: 10s
      retries: 3
    networks:
      - services-network
      - order-db-network
      - rabbitmq-network

  payment-service:
    container_name: payment-service
    hostname: payment-service
    build:
      context: .
      dockerfile: payment-service/Dockerfile
    expose:
      - "${PAYMENT_SERVICE_GRPC_PORT}"
    environment:
      PAYMENT_SERVICE_GRPC_PORT: ${PAYMENT_SERVICE_GRPC_PORT}
      DATABASE_URL: postgres://${PAYMENT_POSTGRES_USER}:${PAYMENT_POSTGRES_PASSWORD}@payment-db:5432/${PAYMENT_POSTGRES_DB}?sslmode=disable
      MIGRATIONS_DIR: /migrations
      LOG_LEVEL: ${LOG_LEVEL}
    depends_on:
      payment-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/grpc_health_probe", "-addr=:${PAYMENT_SERVICE_GRPC_PORT}", "-service=payment-service"]
      interval: 10s
      timeout: 3s
      start_period: 10s
      retries: 3
    networks:
      - services-network
      - payment-db-network

  notification-service:
    container_name: notification-service
    hostname: notification-service
    build:
      context: .
      dockerfile: notification-service/Dockerfile
    environment:
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL}
      LOG_LEVEL: ${LOG_LEVEL}
    depends_on:
      rabbitmq:
        condition: service_healthy
      mailhog:
        condition: service_started
    networks:
      - rabbitmq-network
      - mailhog-network

  search-service:
    container_name: search-service
    hostname: search-service
    build:
      context: .
      dockerfile: search-service/Dockerfile
    environment:
      OPENSEARCH_PRODUCT_INDEX: ${OPENSEARCH_PRODUCT_INDEX}
      OPENSEARCH_ADDRESS: http://opensearch:9200
      OPENSEARCH_USERNAME: ${OPENSEARCH_USERNAME}
      OPENSEARCH_PASSWORD: ${OPENSEARCH_PASSWORD}
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      LOG_LEVEL: ${LOG_LEVEL}
    depends_on:
      opensearch:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - opensearch-network
      - rabbitmq-network

  user-db:
    image: postgres:18-alpine
    container_name: user-db
    hostname: user-db
    environment:
      POSTGRES_DB: ${USER_POSTGRES_DB}
      POSTGRES_USER: ${USER_POSTGRES_USER}
      POSTGRES_PASSWORD: ${USER_POSTGRES_PASSWORD}
    ports:
      - "${USER_DATABASE_PORT}:5432"
    volumes:
      - user_db_data:/var/lib/postgresql/data
    networks:
      - user-db-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${USER_POSTGRES_USER} -d ${USER_POSTGRES_DB}"]
      interval: 5s
      timeout: 3s
      retries: 10

  product-db:
    image: postgres:18-alpine
    container_name: product-db
    hostname: product-db
    environment:
      POSTGRES_DB: ${PRODUCT_POSTGRES_DB}
      POSTGRES_USER: ${PRODUCT_POSTGRES_USER}
      POSTGRES_PASSWORD: ${PRODUCT_POSTGRES_PASSWORD}
    ports:
      - "${PRODUCT_DATABASE_PORT}:5432"
    volumes:
      - product_db_data:/var/lib/postgresql/data
    networks:
      - product-db-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PRODUCT_POSTGRES_USER} -d ${PRODUCT_POSTGRES_DB}"]
      interval: 5s
      timeout: 3s
      retries: 10

  cart-db:
    image: postgres:18-alpine
    container_name: cart-db
    hostname: cart-db
    environment:
      POSTGRES_DB: ${CART_POSTGRES_DB}
      POSTGRES_USER: ${CART_POSTGRES_USER}
      POSTGRES_PASSWORD: ${CART_POSTGRES_PASSWORD}
    ports:
      - "${CART_DATABASE_PORT}:5432"
    volumes:
      - cart_db_data:/var/lib/postgresql/data
    networks:
      - cart-db-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${CART_POSTGRES_USER} -d ${CART_POSTGRES_DB}"]
      interval: 5s
      timeout: 3s
      retries: 10

  order-db:
    image: postgres:18-alpine
    container_name: order-db
    hostname: order-db
    environment:
      POSTGRES_DB: ${ORDER_POSTGRES_DB}
      POSTGRES_USER: ${ORDER_POSTGRES_USER}
      POSTGRES_PASSWORD: ${ORDER_POSTGRES_PASSWORD}
    ports:
      - "${ORDER_DATABASE_PORT}:5432"
    volumes:
      - order_db_data:/var/lib/postgresql/data
    networks:
      - order-db-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${ORDER_POSTGRES_USER} -d ${ORDER_POSTGRES_DB}"]
      interval: 5s
      timeout: 3s
      retries: 10

  payment-db:
    image: postgres:18-alpine
    container_name: payment-db
    hostname: payment-db
    environment:
      POSTGRES_DB: ${PAYMENT_POSTGRES_DB}
      POSTGRES_USER: ${PAYMENT_POSTGRES_USER}
      POSTGRES_PASSWORD: ${PAYMENT_POSTGRES_PASSWORD}
    ports:
      - "${PAYMENT_DATABASE_PORT}:5432"
    volumes:
      - payment_db_data:/var/lib/postgresql/data
    networks:
      - payment-db-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PAYMENT_POSTGRES_USER} -d ${PAYMENT_POSTGRES_DB}"]
      interval: 5s
      timeout: 3s
      retries: 10

  pgadmin:
    image: dpage/pgadmin4:9.9.0
    hostname: pgadmin
    container_name: pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
    ports:
      - "${PGADMIN_PORT}:80"
    depends_on:
      user-db:
        condition: service_healthy
      product-db:
        condition: service_healthy
      cart-db:
        condition: service_healthy
      payment-db:
        condition: service_healthy
      order-db:
        condition: service_healthy
    networks:
      - user-db-network
      - product-db-network
      - cart-db-network
      - payment-db-network
      - order-db-network
    volumes:
      - pgadmin_data:/var/lib/pgadmin

  redis-cache:
    image: redis:8.2.2-alpine3.22
    container_name: redis-cache
    hostname: redis-cache
    expose:
      - ${REDIS_PORT}
    networks:
      - redis-network
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  rabbitmq:
    image: rabbitmq:4.2-management-alpine
    container_name: rabbitmq
    hostname: rabbitmq
    expose:
      - "5672"
    ports:
      - "${RABBITMQ_INTERFACE_PORT}:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    networks:
      - rabbitmq-network
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "status"]
      interval: 10s
      timeout: 5s
      retries: 5

  mailhog:
    image: mailhog/mailhog:latest
    container_name: mailhog
    hostname: mailhog
    expose:
      - "1025"
    ports:
      - "${MAILHOG_HTTP_PORT}:8025"
    networks:
      - mailhog-network

  opensearch:
    image: opensearchproject/opensearch:3.3.2
    container_name: opensearch
    hostname: opensearch
    environment:
      OPENSEARCH_JAVA_OPTS: "-Xms1g -Xmx1g"
      discovery.type: single-node
      DISABLE_SECURITY_PLUGIN: "true"
      bootstrap.memory_lock: "true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    ports:
      - "${OPENSEARCH_PORT}:9200"
    healthcheck:
      test: ["CMD", "curl", "-fs", "http://localhost:9200/_cluster/health"]
      interval: 15s
      timeout: 5s
      retries: 5
    networks:
      - opensearch-network

networks:
  services-network:
  user-db-network:
  product-db-network:
  cart-db-network:
  order-db-network:
  payment-db-network:
  redis-network:
  rabbitmq-network:
  mailhog-network:
  opensearch-network:

volumes:
  user_db_data:
  product_db_data:
  cart_db_data:
  order_db_data:
  payment_db_data:
  redis_data:
  rabbitmq_data:
  pgadmin_data:
  opensearch_data: